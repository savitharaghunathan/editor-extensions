name: E2E Tests

on:
  workflow_call:
    inputs:
      vsix_artifact_name:
        required: true
        type: string
      trigger_context:
        required: true
        type: string # 'pr', 'release', 'manual'
    secrets:
      OPENAI_API_KEY:
        required: false

jobs:
  # Shared setup for all test jobs
  setup:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    outputs:
      core_vsix: ${{ steps.set_vsix_paths.outputs.core_vsix }}
      java_vsix: ${{ steps.set_vsix_paths.outputs.java_vsix }}
      javascript_vsix: ${{ steps.set_vsix_paths.outputs.javascript_vsix }}
      go_vsix: ${{ steps.set_vsix_paths.outputs.go_vsix }}
      csharp_vsix: ${{ steps.set_vsix_paths.outputs.csharp_vsix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Download VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.vsix_artifact_name }}
          path: ./dist

      - name: Set VSIX paths
        id: set_vsix_paths
        run: |
          # Read extension names from package.json files
          CORE_NAME=$(node -p "require('./vscode/core/package.json').name")
          JAVA_NAME=$(node -p "require('./vscode/java/package.json').name")
          JS_NAME=$(node -p "require('./vscode/javascript/package.json').name")
          GO_NAME=$(node -p "require('./vscode/go/package.json').name")
          CSHARP_NAME=$(node -p "require('./vscode/csharp/package.json').name")

          # Find the actual VSIX files
          CORE_VSIX=$(ls ./dist/${CORE_NAME}-*.vsix | head -n 1)
          JAVA_VSIX=$(ls ./dist/${JAVA_NAME}-*.vsix | head -n 1)
          JS_VSIX=$(ls ./dist/${JS_NAME}-*.vsix | head -n 1)
          GO_VSIX=$(ls ./dist/${GO_NAME}-*.vsix | head -n 1)
          CSHARP_VSIX=$(ls ./dist/${CSHARP_NAME}-*.vsix | head -n 1)

          # Verify and output
          for vsix in "$CORE_VSIX" "$JAVA_VSIX" "$JS_VSIX" "$GO_VSIX" "$CSHARP_VSIX"; do
            [ ! -f "$vsix" ] && echo "Error: VSIX not found: $vsix" && exit 1
          done

          echo "core_vsix=${CORE_VSIX}" >> $GITHUB_OUTPUT
          echo "java_vsix=${JAVA_VSIX}" >> $GITHUB_OUTPUT
          echo "javascript_vsix=${JS_VSIX}" >> $GITHUB_OUTPUT
          echo "go_vsix=${GO_VSIX}" >> $GITHUB_OUTPUT
          echo "csharp_vsix=${CSHARP_VSIX}" >> $GITHUB_OUTPUT

  # Critical tests - block PRs and releases
  test-tier0:
    name: Critical Tests (@tier0)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment

      - name: Download VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.vsix_artifact_name }}
          path: ./dist

      - name: Run tier0 tests (excluding slow/infrastructure/offline)
        run: npx playwright test --grep "@tier0" --grep-invert "@slow|@requires-minikube|@offline"
        working-directory: ./tests
        env:
          __TEST_EXTENSION_END_TO_END__: "true"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CORE_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.core_vsix }}
          JAVA_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.java_vsix }}
          JAVASCRIPT_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.javascript_vsix }}
          GO_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.go_vsix }}
          CSHARP_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.csharp_vsix }}

      # This is intentionally kept in a separate step to avoid passing in credentials
      - name: Run tier0 offline tests (no real API calls)
        run: npx playwright test --grep "@tier0" --grep "@offline"
        working-directory: ./tests
        env:
          __TEST_EXTENSION_END_TO_END__: "true"
          OPENAI_API_KEY: <dummy> # this only exists to pass provider validation
          CORE_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.core_vsix }}
          JAVA_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.java_vsix }}
          JAVASCRIPT_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.javascript_vsix }}
          GO_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.go_vsix }}
          CSHARP_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.csharp_vsix }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tier0-test-results
          path: tests/test-output/
          retention-days: 7

  # Important tests - block releases only
  test-tier1:
    name: Important Tests (@tier1)
    runs-on: ubuntu-latest
    needs: setup
    # Only required for releases, but run on PRs for visibility
    continue-on-error: ${{ inputs.trigger_context == 'pr' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment

      - name: Download VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.vsix_artifact_name }}
          path: ./dist

      - name: Run tier1 tests (excluding slow/infrastructure on PRs)
        run: |
          # Check if any tier1 tests exist
          if ! npx playwright test --list --grep "@tier1" 2>&1 | grep -q "Total: 0 tests"; then
            if [ "${{ inputs.trigger_context }}" == "pr" ]; then
              npx playwright test --grep "@tier1" --grep-invert "@slow|@requires-minikube"
            else
              npx playwright test --grep "@tier1" --grep-invert "@requires-minikube"
            fi
          else
            echo "No @tier1 tests found, skipping"
          fi
        working-directory: ./tests
        env:
          __TEST_EXTENSION_END_TO_END__: "true"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CORE_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.core_vsix }}
          JAVA_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.java_vsix }}
          JAVASCRIPT_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.javascript_vsix }}
          GO_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.go_vsix }}
          CSHARP_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.csharp_vsix }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tier1-test-results
          path: tests/test-output/
          retention-days: 7

  # Nice-to-have tests - never block
  test-tier2:
    name: Nice-to-have Tests (@tier2)
    runs-on: ubuntu-latest
    needs: setup
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment

      - name: Download VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.vsix_artifact_name }}
          path: ./dist

      - name: Run tier2 tests
        id: tier2_tests
        run: npx playwright test --grep "@tier2"
        working-directory: ./tests
        continue-on-error: true
        env:
          __TEST_EXTENSION_END_TO_END__: "true"
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CORE_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.core_vsix }}
          JAVA_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.java_vsix }}
          JAVASCRIPT_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.javascript_vsix }}
          GO_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.go_vsix }}
          CSHARP_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.csharp_vsix }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tier2-test-results
          path: tests/test-output/
          retention-days: 7

  # Experimental tests - never block
  test-tier3:
    name: Experimental Tests (@tier3)
    runs-on: ubuntu-latest
    needs: setup
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment

      - name: Download VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.vsix_artifact_name }}
          path: ./dist

      - name: Run tier3 tests
        run: npx playwright test --grep "@tier3"
        working-directory: ./tests
        continue-on-error: true
        env:
          __TEST_EXTENSION_END_TO_END__: "true"
          CORE_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.core_vsix }}
          JAVA_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.java_vsix }}
          JAVASCRIPT_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.javascript_vsix }}
          GO_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.go_vsix }}
          CSHARP_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.csharp_vsix }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tier3-test-results
          path: tests/test-output/
          retention-days: 7

  # Infrastructure tests - requires minikube + Konveyor
  test-infrastructure:
    name: Infrastructure Tests (@requires-minikube)
    runs-on: ubuntu-latest
    needs: setup
    # Only run on releases
    if: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Minikube
        uses: konveyor/operator/.github/actions/start-minikube@main
        with:
          cpus: 4
          memory: 8000

      - name: Install Konveyor
        uses: konveyor/operator/.github/actions/install-konveyor@main

      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment

      - name: Download VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.vsix_artifact_name }}
          path: ./dist

      - name: Get Konveyor Hub URL
        id: get_hub_url
        run: |
          HUB_URL=$(minikube service konveyor-hub -n konveyor --url)
          echo "hub_url=${HUB_URL}" >> $GITHUB_OUTPUT

      - name: Run infrastructure tests
        run: npx playwright test --grep "@requires-minikube"
        working-directory: ./tests
        env:
          __TEST_EXTENSION_END_TO_END__: "true"
          CORE_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.core_vsix }}
          JAVA_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.java_vsix }}
          JAVASCRIPT_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.javascript_vsix }}
          GO_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.go_vsix }}
          CSHARP_VSIX_FILE_PATH: ${{ github.workspace }}/${{ needs.setup.outputs.csharp_vsix }}
          KONVEYOR_HUB_URL: ${{ steps.get_hub_url.outputs.hub_url }}

      - name: Collect infrastructure logs
        if: always()
        run: |
          mkdir -p tests/test-output/k8s-logs
          kubectl logs -n konveyor -l app=konveyor-hub --tail=1000 > tests/test-output/k8s-logs/hub.log || true
          kubectl describe pods -n konveyor > tests/test-output/k8s-logs/pods.txt || true
          kubectl get events -n konveyor > tests/test-output/k8s-logs/events.txt || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-test-results
          path: tests/test-output/
          retention-days: 7

  # Summary job
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-tier0, test-tier1, test-tier2, test-tier3, test-infrastructure]
    if: always()
    steps:
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## E2E Test Results Summary

          | Tier | Status | Blocks PRs | Blocks Releases | Notes |
          |------|--------|------------|-----------------|-------|
          | @tier0 (Critical) | ${{ needs.test-tier0.result }} | âœ… | âœ… | Core functionality |
          | @tier1 (Important) | ${{ needs.test-tier1.result }} | âŒ | âœ… | Production features |
          | @tier2 (Nice-to-have) | ${{ needs.test-tier2.result }} | âŒ | âŒ | Stable validation |
          | @tier3 (Experimental) | ${{ needs.test-tier3.result }} | âŒ | âŒ | Flaky/unstable |
          | Infrastructure (@requires-minikube) | ${{ needs.test-infrastructure.result }} | âŒ | âœ… | Skipped on PRs |

          **Context:** ${{ inputs.trigger_context }}
          **Triggered by:** ${{ github.event_name }}

          ðŸ“Š [Full workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
